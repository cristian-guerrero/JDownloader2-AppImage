#!/bin/sh
set -eu

# Détection du dossier AppDir
if [ -n "${APPDIR:-}" ]; then
  BUNDLE_ROOT="$APPDIR"
  if [ ! -x "$BUNDLE_ROOT/jd2/JDownloader2" ]; then
    ALT_ROOT=$(cd "${0%/*}/.." && pwd)
    if [ -x "$ALT_ROOT/jd2/JDownloader2" ]; then
      BUNDLE_ROOT="$ALT_ROOT"
      APPDIR="$BUNDLE_ROOT"
    fi
  fi
else
  BUNDLE_ROOT=$(cd "${0%/*}/.." && pwd)
  APPDIR="$BUNDLE_ROOT"
fi

BUNDLE_JD="${BUNDLE_ROOT}/jd2"

if [ ! -x "${BUNDLE_JD}/JDownloader2" ]; then
  printf 'JDownloader2 introuvable dans %s\n' "$BUNDLE_JD" >&2
  exit 1
fi

BUILD_MODE=0
if [ "${JD2_APPIMAGE_BUILD:-0}" = 1 ]; then
  BUILD_MODE=1
fi

if [ "$BUILD_MODE" = 1 ]; then
  PERSIST_DIR="$BUNDLE_JD"
else
  DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"
  PERSIST_DIR="${JD2_APPIMAGE_DATA_DIR:-$DATA_HOME/JDownloader2-AppImage}"
  STAMP_FILE="${PERSIST_DIR}/.appimage-source"
  STAMP_SOURCE="${BUNDLE_JD}/JDownloader2"
  if command -v sha256sum >/dev/null 2>&1 && [ -r "$STAMP_SOURCE" ]; then
    CURRENT_STAMP=$(sha256sum "$STAMP_SOURCE" | awk '{print $1}')
  else
    CURRENT_STAMP="${APPIMAGE:-$BUNDLE_ROOT}"
  fi
  CURRENT_STAMP="${CURRENT_STAMP:-${APPIMAGE:-$BUNDLE_ROOT}}"

  mkdir -p "$PERSIST_DIR"

  PREVIOUS_STAMP=""
  if [ -f "$STAMP_FILE" ]; then
    PREVIOUS_STAMP=$(cat "$STAMP_FILE" 2>/dev/null || printf '')
  fi

  if [ "$PREVIOUS_STAMP" != "$CURRENT_STAMP" ]; then
    if [ -n "$PREVIOUS_STAMP" ]; then
      printf 'Mise à jour du profil JDownloader dans %s\n' "$PERSIST_DIR" >&2
    else
      printf 'Initialisation du profil JDownloader dans %s\n' "$PERSIST_DIR" >&2
    fi

    if command -v rsync >/dev/null 2>&1; then
      rsync -a --no-perms --no-owner --no-group "${BUNDLE_JD}/" "$PERSIST_DIR/"
    else
      cp -r "${BUNDLE_JD}/." "$PERSIST_DIR/"
    fi
  fi

  printf '%s\n' "$CURRENT_STAMP" > "$STAMP_FILE"
fi

export JAVA_HOME="$BUNDLE_ROOT/jd2/jre"
export INSTALL4J_JAVA_HOME="$BUNDLE_ROOT/jd2/jre"

# Cap the open-file limit to a sane value to avoid glibc crashes with "unlimited".
ulimit -n 1048576 2>/dev/null || true

cd "$PERSIST_DIR"
exec "$PERSIST_DIR/JDownloader2" "$@"
exit "$?"

