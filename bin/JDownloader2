#!/bin/sh
set -eu

# Détection du dossier AppDir
if [ -n "${APPDIR:-}" ]; then
  BUNDLE_ROOT="$APPDIR"
else
  BUNDLE_ROOT=$(cd "${0%/*}/.." && pwd)
  APPDIR="$BUNDLE_ROOT"
fi

BUNDLE_JD="${BUNDLE_ROOT}/jd2"

if [ ! -x "${BUNDLE_JD}/JDownloader2" ]; then
  printf 'JDownloader2 introuvable dans %s\n' "$BUNDLE_JD" >&2
  exit 1
fi

DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"
PERSIST_DIR="${JD2_APPIMAGE_DATA_DIR:-$DATA_HOME/JDownloader2-AppImage}"
STAMP_FILE="${PERSIST_DIR}/.appimage-source"
STAMP_SOURCE="${BUNDLE_JD}/JDownloader2"
if command -v sha256sum >/dev/null 2>&1 && [ -r "$STAMP_SOURCE" ]; then
  CURRENT_STAMP=$(sha256sum "$STAMP_SOURCE" | awk '{print $1}')
else
  CURRENT_STAMP="${APPIMAGE:-$BUNDLE_ROOT}"
fi
CURRENT_STAMP="${CURRENT_STAMP:-${APPIMAGE:-$BUNDLE_ROOT}}"

mkdir -p "$PERSIST_DIR"

PREVIOUS_STAMP=""
if [ -f "$STAMP_FILE" ]; then
  PREVIOUS_STAMP=$(cat "$STAMP_FILE" 2>/dev/null || printf '')
fi

if [ "$PREVIOUS_STAMP" != "$CURRENT_STAMP" ]; then
  if [ -n "$PREVIOUS_STAMP" ]; then
    printf 'Mise à jour du profil JDownloader dans %s\n' "$PERSIST_DIR" >&2
  else
    printf 'Initialisation du profil JDownloader dans %s\n' "$PERSIST_DIR" >&2
  fi

  if command -v rsync >/dev/null 2>&1; then
    rsync -a --no-perms --no-owner --no-group "${BUNDLE_JD}/" "$PERSIST_DIR/"
  else
    cp -r "${BUNDLE_JD}/." "$PERSIST_DIR/"
  fi
fi

printf '%s\n' "$CURRENT_STAMP" > "$STAMP_FILE"

export JAVA_HOME="$BUNDLE_ROOT/jd2/jre"
export INSTALL4J_JAVA_HOME="$BUNDLE_ROOT/jd2/jre"

adjust_nofile_limit() {
  target=1048576

  # dash busybox n'acceptent pas tous l'option -Sn ; on tente plusieurs syntaxes.
  soft_limit=$(ulimit -Sn 2>/dev/null || ulimit -n 2>/dev/null || printf '')
  hard_limit=$(ulimit -Hn 2>/dev/null || printf '')

  needs_adjustment=false

  case "$soft_limit" in
    '' ) return ;;
    unlimited | infinity )
      needs_adjustment=true
      ;;
    * )
      if printf '%s\n' "$soft_limit" | grep -Eq '^[0-9]+' && [ "$soft_limit" -gt "$target" ]; then
        needs_adjustment=true
      fi
      ;;
  esac

  if [ "$needs_adjustment" = true ]; then
    new_limit=$target
    if [ "$hard_limit" = "unlimited" ] || [ "$hard_limit" = "infinity" ]; then
      :
    elif printf '%s\n' "$hard_limit" | grep -Eq '^[0-9]+'; then
      if [ "$hard_limit" -lt "$new_limit" ]; then
        new_limit=$hard_limit
      fi
    fi

    # Fixe d'abord la hard limit si possible, puis la soft limit.
    ulimit -H -n "$new_limit" 2>/dev/null || true
    ulimit -S -n "$new_limit" 2>/dev/null || ulimit -n "$new_limit" 2>/dev/null || true
  fi
}

adjust_nofile_limit

cd "$PERSIST_DIR"
exec "$PERSIST_DIR/JDownloader2" "$@"
exit "$?"

