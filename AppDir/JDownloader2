#!/bin/bash
# Lanceur universel JDownloader2 AppImage (JRE embarqué ou JVM externe)
set -e

if [ -n "${JD2_APPIMAGE_BUNDLE_DIR:-}" ]; then
  APP_BUNDLE_ROOT="$JD2_APPIMAGE_BUNDLE_DIR"
else
  SCRIPT_PATH="${BASH_SOURCE[0]}"
  while [ -L "$SCRIPT_PATH" ]; do
    LINK_TARGET=$(readlink "$SCRIPT_PATH")
    case "$LINK_TARGET" in
      /*)
        SCRIPT_PATH="$LINK_TARGET"
        ;;
      *)
        SCRIPT_PATH="$(dirname "$SCRIPT_PATH")/$LINK_TARGET"
        ;;
    esac
  done
  SCRIPT_DIR=$(cd "$(dirname "$SCRIPT_PATH")" 2>/dev/null || exit 1; pwd)
  APP_BUNDLE_ROOT="$SCRIPT_DIR"
  for _ in 1 2; do
    if [ -f "$APP_BUNDLE_ROOT/JDownloader.jar" ] || [ -d "$APP_BUNDLE_ROOT/AppDir" ]; then
      break
    fi
    APP_BUNDLE_ROOT=$(cd "$APP_BUNDLE_ROOT/.." 2>/dev/null || exit 1; pwd)
  done
fi

DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"
PERSIST_DIR="${JD2_APPIMAGE_DATA_DIR:-$DATA_HOME/JDownloader2-AppImage}"
STAMP_FILE="$PERSIST_DIR/.appimage-source"
STAMP_SOURCE="$APP_BUNDLE_ROOT/JDownloader.jar"

if command -v sha256sum >/dev/null 2>&1 && [ -r "$STAMP_SOURCE" ]; then
  CURRENT_STAMP=$(sha256sum "$STAMP_SOURCE" | awk '{print $1}')
else
  CURRENT_STAMP="$PWD"
fi
CURRENT_STAMP="${CURRENT_STAMP:-$PWD}"

mkdir -p "$PERSIST_DIR"
PREVIOUS_STAMP=$(cat "$STAMP_FILE" 2>/dev/null || printf '')

if [ "$PREVIOUS_STAMP" != "$CURRENT_STAMP" ]; then
  if [ -n "$PREVIOUS_STAMP" ]; then
    printf 'Mise à jour du profil JDownloader dans %s\n' "$PERSIST_DIR" >&2
  else
    printf 'Initialisation du profil JDownloader dans %s\n' "$PERSIST_DIR" >&2
  fi

  if command -v rsync >/dev/null 2>&1; then
      RSYNC_ARGS=(-a --no-perms --no-owner --no-group)
      case "$PERSIST_DIR" in
        "$APP_BUNDLE_ROOT"/*)
          RSYNC_ARGS+=(--exclude "$(basename "$PERSIST_DIR")")
          ;;
      esac
      rsync "${RSYNC_ARGS[@]}" "$APP_BUNDLE_ROOT/" "$PERSIST_DIR/"
  else
      cp -r "$APP_BUNDLE_ROOT/." "$PERSIST_DIR/"
  fi

  printf '%s\n' "$CURRENT_STAMP" > "$STAMP_FILE"
fi

  cd "$PERSIST_DIR"

if [ ! -f "JDownloader.jar" ]; then
    if [ -f "$APP_BUNDLE_ROOT/JDownloader.jar" ]; then
      cp "$APP_BUNDLE_ROOT/JDownloader.jar" "$PERSIST_DIR/"
    else
      echo "Erreur : JDownloader.jar est introuvable dans $PERSIST_DIR." >&2
      exit 2
    fi
fi

JRE_LOCAL="$PERSIST_DIR/jre"
JAVA_BIN=""

if [ -x "$JRE_LOCAL/bin/java" ]; then
  JAVA_BIN="$JRE_LOCAL/bin/java"
elif [ -n "${INSTALL4J_JAVA_HOME:-}" ] && [ -x "$INSTALL4J_JAVA_HOME/bin/java" ]; then
  JAVA_BIN="$INSTALL4J_JAVA_HOME/bin/java"
elif [ -n "${JAVA_HOME:-}" ] && [ -x "$JAVA_HOME/bin/java" ]; then
  JAVA_BIN="$JAVA_HOME/bin/java"
else
  JAVA_BIN=$(command -v java || true)
fi

JAVA_IS_HEADLESS=0
JAVA_PREFIX=""
if [ -n "$JAVA_BIN" ]; then
  if command -v readlink >/dev/null 2>&1; then
    JAVA_REAL=$(readlink -f "$JAVA_BIN" 2>/dev/null || printf '%s' "$JAVA_BIN")
  elif command -v realpath >/dev/null 2>&1; then
    JAVA_REAL=$(realpath "$JAVA_BIN" 2>/dev/null || printf '%s' "$JAVA_BIN")
  else
    JAVA_REAL="$JAVA_BIN"
  fi

  JAVA_PREFIX=$(cd "$(dirname "$JAVA_REAL")/.." 2>/dev/null || printf '')
  JAVA_MODULE_LIST=$("$JAVA_BIN" --list-modules 2>/dev/null || true)
  if [ -n "$JAVA_MODULE_LIST" ]; then
    if ! printf '%s\n' "$JAVA_MODULE_LIST" | grep -q '^java.desktop@'; then
      JAVA_IS_HEADLESS=1
    fi
  fi
  unset JAVA_MODULE_LIST

  if [ "$JAVA_IS_HEADLESS" = 0 ] && [ -n "$JAVA_PREFIX" ]; then
    if [ ! -e "$JAVA_PREFIX/lib/libawt_xawt.so" ] && [ ! -e "$JAVA_PREFIX/lib/libawt.so" ]; then
      JAVA_IS_HEADLESS=1
    fi
  fi
fi

if [ "$JAVA_IS_HEADLESS" = 1 ]; then
  if [ "${JD2_APPIMAGE_SKIP_JRE_FETCH:-}" = "1" ]; then
    printf 'Avertissement : JVM headless détectée (%s). Certaines fonctionnalités GUI peuvent échouer.\n' "$JAVA_BIN" >&2
  else
    printf "JVM headless détectée (%s). Téléchargement d'un JRE complet Temurin 25 local.\n" "$JAVA_BIN" >&2
    JAVA_BIN=""
  fi
fi

if [ -z "$JAVA_BIN" ]; then
  if [ "${JD2_APPIMAGE_SKIP_JRE_FETCH:-}" = "1" ]; then
    echo "Erreur : aucune JVM disponible et téléchargement automatique désactivé (JD2_APPIMAGE_SKIP_JRE_FETCH=1)." >&2
    exit 83
  fi

  if [ -z "${JD2_APPIMAGE_JRE_URL:-}" ]; then
    API_URL="https://api.adoptium.net/v3/assets/latest/25/hotspot?architecture=x64&heap_size=normal&image_type=jre&jvm_impl=hotspot&os=linux&vendor=adoptium"
    if command -v jq >/dev/null 2>&1; then
      if command -v wget >/dev/null 2>&1; then
        JRE_JSON=$(wget -qO- "$API_URL" || true)
      else
        JRE_JSON=$(curl -sSL "$API_URL" || true)
      fi
      JRE_URL=$(printf '%s' "$JRE_JSON" | jq -r '.[0].binary.package.link' 2>/dev/null || printf '')
    fi

    if [ -z "$JRE_URL" ] || [ "$JRE_URL" = "null" ]; then
      JRE_URL="https://github.com/adoptium/temurin25-binaries/releases/latest/download/OpenJDK25U-jre_x64_linux_hotspot.tar.gz"
    fi
  else
    JRE_URL="$JD2_APPIMAGE_JRE_URL"
  fi

  if [ -z "$JRE_URL" ] || [ "$JRE_URL" = "null" ]; then
    echo "Erreur : impossible d'obtenir l'URL d'un JRE compatible." >&2
    exit 83
  fi
  TMPDIR=$(mktemp -d 2>/dev/null || mktemp -d -t jd2jre)
  TARBALL="$TMPDIR/jre.tar.gz"

  echo "Téléchargement d'un JRE compatible depuis $JRE_URL" >&2
  if ! command -v wget >/dev/null 2>&1 && ! command -v curl >/dev/null 2>&1; then
    echo "Erreur : wget ou curl est requis pour récupérer le JRE manquant." >&2
    rm -rf "$TMPDIR"
    exit 83
  fi

  if command -v wget >/dev/null 2>&1; then
    if ! wget --retry-connrefused --tries=30 -O "$TARBALL" "$JRE_URL"; then
      echo "Erreur : impossible de télécharger le JRE." >&2
      rm -rf "$TMPDIR"
      exit 83
    fi
  else
    if ! curl -L --retry 30 --retry-connrefused -o "$TARBALL" "$JRE_URL"; then
      echo "Erreur : impossible de télécharger le JRE." >&2
      rm -rf "$TMPDIR"
      exit 83
    fi
  fi

  rm -rf "$JRE_LOCAL"
  mkdir -p "$JRE_LOCAL"
  if ! tar -xzf "$TARBALL" --strip-components=1 -C "$JRE_LOCAL"; then
    echo "Erreur : impossible d'extraire le JRE téléchargé." >&2
    rm -rf "$TMPDIR"
    exit 83
  fi
  rm -rf "$TMPDIR"

  if [ -x "$JRE_LOCAL/bin/java" ]; then
    JAVA_BIN="$JRE_LOCAL/bin/java"
  fi
fi

if [ -z "$JAVA_BIN" ]; then
  echo "Erreur : aucune JVM compatible trouvée (JRE embarqué, téléchargé ou système)." >&2
  exit 83
fi

printf 'JVM utilisée : %s\n' "$JAVA_BIN" >&2

exec "$JAVA_BIN" -jar JDownloader.jar "$@"
