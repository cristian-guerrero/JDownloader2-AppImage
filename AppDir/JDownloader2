#!/bin/bash
# Lanceur universel JDownloader2 AppImage (JRE embarqué ou JVM externe)
set -e

if [ -n "${JD2_APPIMAGE_BUNDLE_DIR:-}" ]; then
  APP_BUNDLE_ROOT="$JD2_APPIMAGE_BUNDLE_DIR"
else
  SCRIPT_PATH="${BASH_SOURCE[0]}"
  while [ -L "$SCRIPT_PATH" ]; do
    LINK_TARGET=$(readlink "$SCRIPT_PATH")
    case "$LINK_TARGET" in
      /*)
        SCRIPT_PATH="$LINK_TARGET"
        ;;
      *)
        SCRIPT_PATH="$(dirname "$SCRIPT_PATH")/$LINK_TARGET"
        ;;
    esac
  done
  SCRIPT_DIR=$(cd "$(dirname "$SCRIPT_PATH")" 2>/dev/null || exit 1; pwd)
  APP_BUNDLE_ROOT="$SCRIPT_DIR"
  for _ in 1 2; do
    if [ -f "$APP_BUNDLE_ROOT/JDownloader.jar" ] || [ -d "$APP_BUNDLE_ROOT/AppDir" ]; then
      break
    fi
    APP_BUNDLE_ROOT=$(cd "$APP_BUNDLE_ROOT/.." 2>/dev/null || exit 1; pwd)
  done
fi

DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"
PERSIST_DIR="${JD2_APPIMAGE_DATA_DIR:-$DATA_HOME/JDownloader2-AppImage}"
STAMP_FILE="$PERSIST_DIR/.appimage-source"
STAMP_SOURCE="$APP_BUNDLE_ROOT/JDownloader.jar"

if command -v sha256sum >/dev/null 2>&1 && [ -r "$STAMP_SOURCE" ]; then
  CURRENT_STAMP=$(sha256sum "$STAMP_SOURCE" | awk '{print $1}')
else
  CURRENT_STAMP="$PWD"
fi
CURRENT_STAMP="${CURRENT_STAMP:-$PWD}"

mkdir -p "$PERSIST_DIR"
PREVIOUS_STAMP=$(cat "$STAMP_FILE" 2>/dev/null || printf '')

if [ "$PREVIOUS_STAMP" != "$CURRENT_STAMP" ]; then
  if [ -n "$PREVIOUS_STAMP" ]; then
    printf 'Mise à jour du profil JDownloader dans %s\n' "$PERSIST_DIR" >&2
  else
    printf 'Initialisation du profil JDownloader dans %s\n' "$PERSIST_DIR" >&2
  fi

  if command -v rsync >/dev/null 2>&1; then
      RSYNC_ARGS=(-a --no-perms --no-owner --no-group)
      case "$PERSIST_DIR" in
        "$APP_BUNDLE_ROOT"/*)
          RSYNC_ARGS+=(--exclude "$(basename "$PERSIST_DIR")")
          ;;
      esac
      rsync "${RSYNC_ARGS[@]}" "$APP_BUNDLE_ROOT/" "$PERSIST_DIR/"
  else
      cp -r "$APP_BUNDLE_ROOT/." "$PERSIST_DIR/"
  fi

  printf '%s\n' "$CURRENT_STAMP" > "$STAMP_FILE"
fi

  cd "$PERSIST_DIR"

if [ ! -f "JDownloader.jar" ]; then
    if [ -f "$APP_BUNDLE_ROOT/JDownloader.jar" ]; then
      cp "$APP_BUNDLE_ROOT/JDownloader.jar" "$PERSIST_DIR/"
    else
      echo "Erreur : JDownloader.jar est introuvable dans $PERSIST_DIR." >&2
      exit 2
    fi
fi

JRE_LOCAL="$PERSIST_DIR/jre"
JAVA_BIN=""
JAVA_IS_HEADLESS=0
JAVA_HEADLESS_CANDIDATE=""

declare -a JAVA_CANDIDATES=()
declare -A JAVA_SEEN=()

add_java_candidate() {
  local candidate="$1"
  if [ -n "$candidate" ] && [ -x "$candidate" ]; then
    if [ -z "${JAVA_SEEN[$candidate]:-}" ]; then
      JAVA_SEEN["$candidate"]=1
      JAVA_CANDIDATES+=("$candidate")
    fi
  fi
}

add_java_candidate "$JRE_LOCAL/bin/java"
add_java_candidate "${INSTALL4J_JAVA_HOME:-}/bin/java"
add_java_candidate "${JAVA_HOME:-}/bin/java"

if command -v java >/dev/null 2>&1; then
  PATH_JAVA_LIST=$(command -v -a java 2>/dev/null || printf '')
  while IFS= read -r path; do
    add_java_candidate "$path"
  done <<< "$PATH_JAVA_LIST"
  unset PATH_JAVA_LIST
fi

for candidate in "${JAVA_CANDIDATES[@]}"; do
  CANDIDATE_HEADLESS=0
  if command -v readlink >/dev/null 2>&1; then
    CANDIDATE_REAL=$(readlink -f "$candidate" 2>/dev/null || printf '%s' "$candidate")
  elif command -v realpath >/dev/null 2>&1; then
    CANDIDATE_REAL=$(realpath "$candidate" 2>/dev/null || printf '%s' "$candidate")
  else
    CANDIDATE_REAL="$candidate"
  fi

  CANDIDATE_PREFIX=$(cd "$(dirname "$CANDIDATE_REAL")/.." 2>/dev/null && pwd || printf '')
  if [ -z "$CANDIDATE_PREFIX" ] || [ "$CANDIDATE_PREFIX" = "/" ]; then
    CANDIDATE_PREFIX=""
  fi

  CANDIDATE_MODULE_LIST=$("$candidate" --list-modules 2>/dev/null || true)
  if [ -n "$CANDIDATE_MODULE_LIST" ]; then
    if ! printf '%s\n' "$CANDIDATE_MODULE_LIST" | grep -q '^java.desktop@'; then
      CANDIDATE_HEADLESS=1
    fi
  fi
  unset CANDIDATE_MODULE_LIST

  if [ "$CANDIDATE_HEADLESS" = 0 ] && [ -n "$CANDIDATE_PREFIX" ]; then
    if ! find "$CANDIDATE_PREFIX" -maxdepth 3 -type f \( -name 'libawt_xawt.so' -o -name 'libawt_xawt.dylib' \) -print -quit >/dev/null; then
      CANDIDATE_HEADLESS=1
    fi
  fi

  if [ "$CANDIDATE_HEADLESS" = 0 ]; then
    JAVA_BIN="$candidate"
    JAVA_IS_HEADLESS=0
    break
  fi

  if [ -z "$JAVA_HEADLESS_CANDIDATE" ]; then
    JAVA_HEADLESS_CANDIDATE="$candidate"
  fi
done

unset CANDIDATE_HEADLESS
unset CANDIDATE_REAL
unset CANDIDATE_PREFIX

if [ -z "$JAVA_BIN" ] && [ -n "$JAVA_HEADLESS_CANDIDATE" ]; then
  JAVA_IS_HEADLESS=1
fi

unset JAVA_CANDIDATES
unset JAVA_SEEN

if [ "$JAVA_IS_HEADLESS" = 1 ]; then
  if [ "${JD2_APPIMAGE_SKIP_JRE_FETCH:-}" = "1" ]; then
    printf 'Avertissement : JVM headless détectée (%s). Certaines fonctionnalités GUI peuvent échouer.\n' "$JAVA_HEADLESS_CANDIDATE" >&2
  else
    printf "JVM headless détectée (%s). Téléchargement d'un JRE complet Temurin 25 local.\n" "$JAVA_HEADLESS_CANDIDATE" >&2
  fi
fi

if [ -z "$JAVA_BIN" ]; then
  if [ "${JD2_APPIMAGE_SKIP_JRE_FETCH:-}" = "1" ]; then
    echo "Erreur : aucune JVM disponible et téléchargement automatique désactivé (JD2_APPIMAGE_SKIP_JRE_FETCH=1)." >&2
    exit 83
  fi

  if [ -z "${JD2_APPIMAGE_JRE_URL:-}" ]; then
    API_URL="https://api.adoptium.net/v3/assets/latest/25/hotspot?architecture=x64&heap_size=normal&image_type=jre&jvm_impl=hotspot&os=linux&vendor=adoptium"
    if command -v jq >/dev/null 2>&1; then
      if command -v wget >/dev/null 2>&1; then
        JRE_JSON=$(wget -qO- "$API_URL" || true)
      else
        JRE_JSON=$(curl -sSL "$API_URL" || true)
      fi
      JRE_URL=$(printf '%s' "$JRE_JSON" | jq -r '.[0].binary.package.link' 2>/dev/null || printf '')
    fi

    if [ -z "$JRE_URL" ] || [ "$JRE_URL" = "null" ]; then
      JRE_URL="https://github.com/adoptium/temurin25-binaries/releases/download/jdk-25.0.1%2B8/OpenJDK25U-jre_x64_linux_hotspot_25.0.1_8.tar.gz"
    fi
  else
    JRE_URL="$JD2_APPIMAGE_JRE_URL"
  fi

  if [ -z "$JRE_URL" ] || [ "$JRE_URL" = "null" ]; then
    echo "Erreur : impossible d'obtenir l'URL d'un JRE compatible." >&2
    exit 83
  fi
  TMPDIR=$(mktemp -d 2>/dev/null || mktemp -d -t jd2jre)
  TARBALL="$TMPDIR/jre.tar.gz"

  echo "Téléchargement d'un JRE compatible depuis $JRE_URL" >&2
  if ! command -v wget >/dev/null 2>&1 && ! command -v curl >/dev/null 2>&1; then
    echo "Erreur : wget ou curl est requis pour récupérer le JRE manquant." >&2
    rm -rf "$TMPDIR"
    exit 83
  fi

  if command -v wget >/dev/null 2>&1; then
    if ! wget --retry-connrefused --tries=30 -O "$TARBALL" "$JRE_URL"; then
      echo "Erreur : impossible de télécharger le JRE." >&2
      rm -rf "$TMPDIR"
      exit 83
    fi
  else
    if ! curl -L --retry 30 --retry-connrefused -o "$TARBALL" "$JRE_URL"; then
      echo "Erreur : impossible de télécharger le JRE." >&2
      rm -rf "$TMPDIR"
      exit 83
    fi
  fi

  rm -rf "$JRE_LOCAL"
  mkdir -p "$JRE_LOCAL"
  if ! tar -xzf "$TARBALL" --strip-components=1 -C "$JRE_LOCAL"; then
    echo "Erreur : impossible d'extraire le JRE téléchargé." >&2
    rm -rf "$TMPDIR"
    exit 83
  fi
  rm -rf "$TMPDIR"

  if [ -x "$JRE_LOCAL/bin/java" ]; then
    JAVA_BIN="$JRE_LOCAL/bin/java"
  fi
fi

if [ -z "$JAVA_BIN" ]; then
  echo "Erreur : aucune JVM compatible trouvée (JRE embarqué, téléchargé ou système)." >&2
  exit 83
fi

printf 'JVM utilisée : %s\n' "$JAVA_BIN" >&2

exec "$JAVA_BIN" -jar JDownloader.jar "$@"
