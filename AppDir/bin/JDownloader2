#!/bin/bash
# Lanceur universel JDownloader2 AppImage (JRE embarqué ou JVM externe)
set -e

if [ -n "${JD2_APPIMAGE_BUNDLE_DIR:-}" ]; then
  APP_BUNDLE_ROOT="$JD2_APPIMAGE_BUNDLE_DIR"
else
  SCRIPT_PATH="${BASH_SOURCE[0]}"
  while [ -L "$SCRIPT_PATH" ]; do
    LINK_TARGET=$(readlink "$SCRIPT_PATH")
    case "$LINK_TARGET" in
      /*)
        SCRIPT_PATH="$LINK_TARGET"
        ;;
      *)
        SCRIPT_PATH="$(dirname "$SCRIPT_PATH")/$LINK_TARGET"
        ;;
    esac
  done
  SCRIPT_DIR=$(cd "$(dirname "$SCRIPT_PATH")" 2>/dev/null || exit 1; pwd)
  APP_BUNDLE_ROOT="$SCRIPT_DIR"
  for _ in 1 2; do
    if [ -f "$APP_BUNDLE_ROOT/JDownloader.jar" ] || [ -d "$APP_BUNDLE_ROOT/AppDir" ]; then
      break
    fi
    APP_BUNDLE_ROOT=$(cd "$APP_BUNDLE_ROOT/.." 2>/dev/null || exit 1; pwd)
  done
fi

DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"
if [ "${JD2_APPIMAGE_BUILD:-}" = "1" ]; then
  # Pas d'initialisation du profil pendant le build
  exit 0
fi
PERSIST_DIR="${JD2_APPIMAGE_DATA_DIR:-$DATA_HOME/JDownloader2}"
STAMP_FILE="$PERSIST_DIR/.appimage-source"
STAMP_SOURCE="$APP_BUNDLE_ROOT/JDownloader.jar"

if command -v sha256sum >/dev/null 2>&1 && [ -r "$STAMP_SOURCE" ]; then
  CURRENT_STAMP=$(sha256sum "$STAMP_SOURCE" | awk '{print $1}')
else
  CURRENT_STAMP="$PWD"
fi
CURRENT_STAMP="${CURRENT_STAMP:-$PWD}"

mkdir -p "$PERSIST_DIR"
PREVIOUS_STAMP=$(cat "$STAMP_FILE" 2>/dev/null || printf '')

if [ "$PREVIOUS_STAMP" != "$CURRENT_STAMP" ]; then
  if [ -n "$PREVIOUS_STAMP" ]; then
    printf 'Mise à jour du profil JDownloader dans %s\n' "$PERSIST_DIR" >&2
  else
    printf 'Initialisation du profil JDownloader dans %s\n' "$PERSIST_DIR" >&2
  fi

  if command -v rsync >/dev/null 2>&1; then
      RSYNC_ARGS=(-a --no-perms --no-owner --no-group)
      if [ -z "${JD2_APPIMAGE_BUILD:-}" ]; then
         RSYNC_ARGS+=(--exclude 'jre.tar.gz')
      fi
      case "$PERSIST_DIR" in
        "$APP_BUNDLE_ROOT"/*)
          RSYNC_ARGS+=(--exclude "$(basename "$PERSIST_DIR")")
          ;;
      esac
      rsync "${RSYNC_ARGS[@]}" "$APP_BUNDLE_ROOT/" "$PERSIST_DIR/"
  else
      if [ -z "${JD2_APPIMAGE_BUILD:-}" ]; then
        find "$APP_BUNDLE_ROOT" -mindepth 1 -maxdepth 1 ! -name 'jre.tar.gz' -exec cp -r {} "$PERSIST_DIR/" \;
      else
        cp -r "$APP_BUNDLE_ROOT/." "$PERSIST_DIR/"
      fi
  fi

  printf '%s\n' "$CURRENT_STAMP" > "$STAMP_FILE"
fi

  cd "$PERSIST_DIR"

if [ ! -f "JDownloader.jar" ]; then
    if [ -f "$APP_BUNDLE_ROOT/JDownloader.jar" ]; then
      cp "$APP_BUNDLE_ROOT/JDownloader.jar" "$PERSIST_DIR/"
    else
      echo "Erreur : JDownloader.jar est introuvable dans $PERSIST_DIR." >&2
      exit 2
    fi
fi

JRE_LOCAL="$PERSIST_DIR/jre"
JAVA_BIN=""
JAVA_IS_HEADLESS=0
JAVA_HEADLESS_CANDIDATE=""

declare -a JAVA_CANDIDATES=()
declare -A JAVA_SEEN=()

add_java_candidate() {
  local candidate="$1"
  if [ -n "$candidate" ] && [ -x "$candidate" ]; then
    if [ -z "${JAVA_SEEN[$candidate]:-}" ]; then
      JAVA_SEEN["$candidate"]=1
      JAVA_CANDIDATES+=("$candidate")
    fi
  fi
}

add_java_dir_candidate() {
  local dir="${1%/}"
  if [ -n "$dir" ] && [ "$dir" != "/" ]; then
    add_java_candidate "$dir/bin/java"
  fi
}

add_java_glob_candidates() {
  local pattern
  local entry
  local oldifs="$IFS"
  shopt -s nullglob
  IFS=$'\n'
  for pattern in "$@"; do
    for entry in $pattern; do
      if [ -d "$entry" ]; then
        add_java_dir_candidate "$entry"
      fi
    done
  done
  IFS="$oldifs"
  shopt -u nullglob
}

add_java_dir_from_file() {
  local cfg="$1"
  local line
  if [ -f "$cfg" ]; then
    if IFS= read -r line < "$cfg"; then
      add_java_dir_candidate "$line"
    fi
  fi
}

declare -a JAVA_KNOWN_PREFIX_PATTERNS=(
  "/usr/lib/jvm/*"
  "/usr/lib/java*"
  "/usr/lib/jdk*"
  "/usr/lib/jre*"
  "/usr/lib/j2*re*"
  "/usr/lib/j2sdk*"
  "/usr/java*"
  "/usr/java*/jre"
  "/usr/java/j2*re*"
  "/usr/java/j2sdk*"
  "/usr/jdk*"
  "/usr/jre*"
  "/usr/j2*re*"
  "/usr/j2sdk*"
  "/usr/local/java*"
  "/usr/local/jdk*"
  "/usr/local/jre*"
  "/opt/java*"
  "/opt/jdk*"
  "/opt/jre*"
  "/Library/Java/JavaVirtualMachines/*.jdk/Contents/Home"
  "/Library/Java/JavaVirtualMachines/*.jre/Contents/Home"
  "/Library/Internet Plug-Ins/JavaAppletPlugin.plugin/Contents/Home"
  "/System/Library/Frameworks/JavaVM.framework/Versions/*/Home"
)

add_java_dir_candidate "${JAVA_HOME:-}"
add_java_dir_candidate "${JDK_HOME:-}"
add_java_dir_candidate "${JRE_HOME:-}"

if command -v java >/dev/null 2>&1; then
  PATH_JAVA_LIST=$(command -v -a java 2>/dev/null || printf '')
  while IFS= read -r path; do
    add_java_candidate "$path"
  done <<< "$PATH_JAVA_LIST"
  unset PATH_JAVA_LIST
fi

if [ -n "${JD2_APPIMAGE_EXTRA_JAVA_DIRS:-}" ]; then
  while IFS= read -r extra_dir; do
    add_java_dir_candidate "$extra_dir"
  done <<EOF
$(printf '%s\n' "${JD2_APPIMAGE_EXTRA_JAVA_DIRS}" | tr ':' '\n')
EOF
fi

add_java_glob_candidates "${JAVA_KNOWN_PREFIX_PATTERNS[@]}"

add_java_candidate "$JRE_LOCAL/bin/java"

for candidate in "${JAVA_CANDIDATES[@]}"; do
  CANDIDATE_HEADLESS=0
  if command -v readlink >/dev/null 2>&1; then
    CANDIDATE_REAL=$(readlink -f "$candidate" 2>/dev/null || printf '%s' "$candidate")
  elif command -v realpath >/dev/null 2>&1; then
    CANDIDATE_REAL=$(realpath "$candidate" 2>/dev/null || printf '%s' "$candidate")
  else
    CANDIDATE_REAL="$candidate"
  fi

  CANDIDATE_PREFIX=$(cd "$(dirname "$CANDIDATE_REAL")/.." 2>/dev/null && pwd || printf '')
  if [ -z "$CANDIDATE_PREFIX" ] || [ "$CANDIDATE_PREFIX" = "/" ]; then
    CANDIDATE_PREFIX=""
  fi

  CANDIDATE_MODULE_LIST=$("$candidate" --list-modules 2>/dev/null || true)
  if [ -n "$CANDIDATE_MODULE_LIST" ]; then
    if ! printf '%s\n' "$CANDIDATE_MODULE_LIST" | grep -q '^java.desktop@'; then
      CANDIDATE_HEADLESS=1
    fi
  fi
  unset CANDIDATE_MODULE_LIST

  if [ "$CANDIDATE_HEADLESS" = 0 ] && [ -n "$CANDIDATE_PREFIX" ]; then
    CANDIDATE_AWT=$(find "$CANDIDATE_PREFIX" -maxdepth 3 -type f \( -name 'libawt_xawt.so' -o -name 'libawt_xawt.dylib' \) -print -quit 2>/dev/null || printf '')
    if [ -z "$CANDIDATE_AWT" ]; then
      CANDIDATE_HEADLESS=1
    fi
  fi

  if [ "$CANDIDATE_HEADLESS" = 0 ]; then
    JAVA_BIN="$CANDIDATE_REAL"
    JAVA_IS_HEADLESS=0
    break
  fi

  if [ -z "$JAVA_HEADLESS_CANDIDATE" ]; then
    JAVA_HEADLESS_CANDIDATE="$CANDIDATE_REAL"
  fi
done

unset CANDIDATE_HEADLESS
unset CANDIDATE_REAL
unset CANDIDATE_PREFIX
unset CANDIDATE_AWT

if [ -z "$JAVA_BIN" ] && [ -n "$JAVA_HEADLESS_CANDIDATE" ]; then
  JAVA_IS_HEADLESS=1
fi

unset JAVA_CANDIDATES
unset JAVA_SEEN

if [ "$JAVA_IS_HEADLESS" = 1 ]; then
  if [ "${JD2_APPIMAGE_SKIP_JRE_FETCH:-}" = "1" ]; then
    printf 'Avertissement : JVM headless détectée (%s). Certaines fonctionnalités GUI peuvent échouer.\n' "$JAVA_HEADLESS_CANDIDATE" >&2
  else
    printf "JVM headless détectée (%s). Téléchargement d'un JRE complet Temurin 25 local.\n" "$JAVA_HEADLESS_CANDIDATE" >&2
  fi
fi

if [ -n "$JAVA_BIN" ] && [ "${JAVA_BIN#$JRE_LOCAL/}" = "$JAVA_BIN" ]; then
  if [ -d "$JRE_LOCAL" ]; then
    rm -rf "$JRE_LOCAL"
  fi
fi

if [ -z "$JAVA_BIN" ]; then
  # Si aucun JRE système, décompresser l'archive embarquée AppDir/jre.tar.gz
  JRE_ARCHIVE="$APP_BUNDLE_ROOT/jre.tar.gz"
  if [ ! -f "$JRE_ARCHIVE" ]; then
    echo "Erreur : aucune JVM disponible et aucune archive JRE embarquée ($JRE_ARCHIVE)." >&2
    exit 83
  fi
  if ! command -v tar >/dev/null 2>&1; then
    echo "Erreur : l'outil tar est requis pour décompresser le JRE embarqué." >&2
    exit 83
  fi
  echo "Décompression du JRE embarqué depuis $JRE_ARCHIVE dans $JRE_LOCAL" >&2
  rm -rf "$JRE_LOCAL"
  mkdir -p "$JRE_LOCAL"
  if ! tar -xzf "$JRE_ARCHIVE" --strip-components=1 -C "$JRE_LOCAL"; then
    echo "Erreur : impossible d'extraire le JRE embarqué." >&2
    exit 83
  fi
  if [ -x "$JRE_LOCAL/bin/java" ]; then
    JAVA_BIN="$JRE_LOCAL/bin/java"
  fi
fi

if [ -z "$JAVA_BIN" ]; then
  echo "Erreur : aucune JVM compatible trouvée (JRE embarqué, téléchargé ou système)." >&2
  exit 83
fi

printf 'JVM utilisée : %s\n' "$JAVA_BIN" >&2

# >>> JD2 AppImage JVM options block >>>
declare -a JD2_JAVA_OPTS=('-server')
declare -a JD2_APP_ARGS=()

jd2_read_vmoptions() {
  local file="$1"
  local line trimmed
  [ -r "$file" ] || return 0
  while IFS= read -r line || [ -n "$line" ]; do
    case "$line" in
      ''|'#'*)
        continue
        ;;
    esac
    trimmed="${line%$'\r'}"
    JD2_JAVA_OPTS+=("$trimmed")
  done <"$file"
}

declare -a JD2_VMOPT_FILES=()
if [ -n "${JD2_VMOPTIONS_PATH:-}" ]; then
  IFS=':' read -r -a JD2_VMOPT_FILES <<< "${JD2_VMOPTIONS_PATH}"
  IFS=$' \t\n'
else
  JD2_VMOPT_FILES+=("$PERSIST_DIR/JDownloader2.vmoptions")
  if [ "$PERSIST_DIR" != "$APP_BUNDLE_ROOT" ]; then
    JD2_VMOPT_FILES+=("$APP_BUNDLE_ROOT/JDownloader2.vmoptions")
  fi
fi

for jd2_vm_file in "${JD2_VMOPT_FILES[@]}"; do
  [ -n "$jd2_vm_file" ] || continue
  jd2_read_vmoptions "$jd2_vm_file"
done

for arg in "$@"; do
  if [[ $arg == -J* ]]; then
    if [ "${#arg}" -gt 2 ]; then
      JD2_JAVA_OPTS+=("${arg:2}")
    fi
  else
    JD2_APP_ARGS+=("$arg")
  fi
done
set -- "${JD2_APP_ARGS[@]}"

JD2_JAVA_VERSION=$("$JAVA_BIN" -version 2>&1 | awk -F '"' '/version/ {print $2; exit}')
JD2_JAVA_MAJOR=""
if [ -n "$JD2_JAVA_VERSION" ]; then
  case "$JD2_JAVA_VERSION" in
    1.*)
      JD2_JAVA_MAJOR=${JD2_JAVA_VERSION#1.}
      JD2_JAVA_MAJOR=${JD2_JAVA_MAJOR%%.*}
      ;;
    *)
      JD2_JAVA_MAJOR=${JD2_JAVA_VERSION%%.*}
      ;;
  esac
fi

if [[ $JD2_JAVA_MAJOR =~ ^[0-9]+$ ]] && [[ $JD2_JAVA_VERSION != 1.* ]] && (( JD2_JAVA_MAJOR >= 9 )); then
  JD2_JAVA_OPTS+=(
    '--add-exports=java.desktop/sun.swing=ALL-UNNAMED'
    '--add-exports=java.desktop/sun.swing.table=ALL-UNNAMED'
    '--add-exports=java.desktop/sun.swing.plaf.synth=ALL-UNNAMED'
    '--add-opens=java.desktop/javax.swing.plaf.synth=ALL-UNNAMED'
    '--add-opens=java.desktop/javax.swing.plaf.basic=ALL-UNNAMED'
    '--add-opens=java.desktop/javax.swing=ALL-UNNAMED'
    '--add-opens=java.desktop/javax.swing.tree=ALL-UNNAMED'
    '--add-opens=java.desktop/java.awt.event=ALL-UNNAMED'
    '--add-exports=java.desktop/sun.awt.shell=ALL-UNNAMED'
    '--add-exports=java.base/sun.security.action=ALL-UNNAMED'
    '--add-exports=java.desktop/com.sun.awt=ALL-UNNAMED'
    '--add-exports=java.desktop/com.sun.java.swing.plaf.windows=ALL-UNNAMED'
  )
fi
# <<< JD2 AppImage JVM options block <<<

exec "$JAVA_BIN" "${JD2_JAVA_OPTS[@]}" -jar JDownloader.jar "$@"
